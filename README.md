<div style="text-align: center;">
  <p align="center" style="font-size: 32px; font-weight: bold;">ğŸŒ˜ ä¸€ç§åŸºäºå›¾å‘é‡å’Œå‘é‡æ•°æ®åº“çš„å›¾ç‰‡æœç´¢å¼•æ“ã€‚</p>
</div>

![](img/logo.png)

--- 

## ä»‹ç»

ğŸ’¡ ä¸€ç§åˆ©ç”¨ [langchain](https://github.com/hwchase17/langchain) æ€æƒ³å®ç°çš„åŸºäºæœ¬åœ°çŸ¥è¯†åº“çš„é—®ç­”åº”ç”¨ï¼Œç›®æ ‡æœŸæœ›å»ºç«‹ä¸€å¥—å¯¹ä¸­æ–‡åœºæ™¯ä¸å¼€æºæ¨¡å‹æ”¯æŒå‹å¥½ã€å¯ç¦»çº¿è¿è¡Œçš„çŸ¥è¯†åº“é—®ç­”è§£å†³æ–¹æ¡ˆã€‚

ğŸ’¡ å— [GanymedeNil](https://github.com/GanymedeNil) çš„é¡¹ç›® [document.ai](https://github.com/GanymedeNil/document.ai) å’Œ [AlexZhangji](https://github.com/AlexZhangji) åˆ›å»ºçš„ [ChatGLM-6B Pull Request](https://github.com/THUDM/ChatGLM-6B/pull/216) å¯å‘ï¼Œå»ºç«‹äº†å…¨æµç¨‹å¯ä½¿ç”¨å¼€æºæ¨¡å‹å®ç°çš„æœ¬åœ°çŸ¥è¯†åº“é—®ç­”åº”ç”¨ã€‚æœ¬é¡¹ç›®çš„æœ€æ–°ç‰ˆæœ¬ä¸­é€šè¿‡ä½¿ç”¨ [FastChat](https://github.com/lm-sys/FastChat) æ¥å…¥ Vicuna, Alpaca, LLaMA, Koala, RWKV ç­‰æ¨¡å‹ï¼Œä¾æ‰˜äº [langchain](https://github.com/langchain-ai/langchain) æ¡†æ¶æ”¯æŒé€šè¿‡åŸºäº [FastAPI](https://github.com/tiangolo/fastapi) æä¾›çš„ API è°ƒç”¨æœåŠ¡ï¼Œæˆ–ä½¿ç”¨åŸºäº [Streamlit](https://github.com/streamlit/streamlit) çš„ WebUI è¿›è¡Œæ“ä½œã€‚

âœ… ä¾æ‰˜äºæœ¬é¡¹ç›®æ”¯æŒçš„å¼€æº LLM ä¸ Embedding æ¨¡å‹ï¼Œæœ¬é¡¹ç›®å¯å®ç°å…¨éƒ¨ä½¿ç”¨**å¼€æº**æ¨¡å‹**ç¦»çº¿ç§æœ‰éƒ¨ç½²**ã€‚ä¸æ­¤åŒæ—¶ï¼Œæœ¬é¡¹ç›®ä¹Ÿæ”¯æŒ OpenAI GPT API çš„è°ƒç”¨ï¼Œå¹¶å°†åœ¨åç»­æŒç»­æ‰©å……å¯¹å„ç±»æ¨¡å‹åŠæ¨¡å‹ API çš„æ¥å…¥ã€‚

â›“ï¸ æœ¬é¡¹ç›®å®ç°åŸç†å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¿‡ç¨‹åŒ…æ‹¬åŠ è½½æ–‡ä»¶ -> è¯»å–æ–‡æœ¬ -> æ–‡æœ¬åˆ†å‰² -> æ–‡æœ¬å‘é‡åŒ– -> é—®å¥å‘é‡åŒ– -> åœ¨æ–‡æœ¬å‘é‡ä¸­åŒ¹é…å‡ºä¸é—®å¥å‘é‡æœ€ç›¸ä¼¼çš„ `top k`ä¸ª -> åŒ¹é…å‡ºçš„æ–‡æœ¬ä½œä¸ºä¸Šä¸‹æ–‡å’Œé—®é¢˜ä¸€èµ·æ·»åŠ åˆ° `prompt`ä¸­ -> æäº¤ç»™ `LLM`ç”Ÿæˆå›ç­”ã€‚

ğŸ“º å®ç°åŸç†

![å®ç°åŸç†å›¾](img/langchain+chatglm.png)

ä»æ–‡æ¡£å¤„ç†è§’åº¦æ¥çœ‹ï¼Œå®ç°æµç¨‹å¦‚ä¸‹ï¼š

![å®ç°åŸç†å›¾2](img/langchain+chatglm2.png)

ğŸš© æœ¬é¡¹ç›®æœªæ¶‰åŠå¾®è°ƒã€è®­ç»ƒè¿‡ç¨‹ï¼Œä½†å¯åˆ©ç”¨å¾®è°ƒæˆ–è®­ç»ƒå¯¹æœ¬é¡¹ç›®æ•ˆæœè¿›è¡Œä¼˜åŒ–ã€‚

---

## Docker éƒ¨ç½²

ğŸ³ Docker é•œåƒåœ°å€: `registry.cn-beijing.aliyuncs.com/chatchat/chatchat:0.2.0)`

```shell
docker run -d --gpus all -p 80:8501 registry.cn-beijing.aliyuncs.com/chatchat/chatchat:0.2.0
```

- è¯¥ç‰ˆæœ¬é•œåƒå¤§å° `33.9GB`ï¼Œä½¿ç”¨ `v0.2.0`ï¼Œä»¥ `nvidia/cuda:12.1.1-cudnn8-devel-ubuntu22.04` ä¸ºåŸºç¡€é•œåƒ
- è¯¥ç‰ˆæœ¬å†…ç½®ä¸€ä¸ª `embedding` æ¨¡å‹ï¼š`m3e-large`ï¼Œå†…ç½® `fastchat+chatglm2-6b-32k`
- è¯¥ç‰ˆæœ¬ç›®æ ‡ä¸ºæ–¹ä¾¿ä¸€é”®éƒ¨ç½²ä½¿ç”¨ï¼Œè¯·ç¡®ä¿æ‚¨å·²ç»åœ¨Linuxå‘è¡Œç‰ˆä¸Šå®‰è£…äº†NVIDIAé©±åŠ¨ç¨‹åº
- è¯·æ³¨æ„ï¼Œæ‚¨ä¸éœ€è¦åœ¨ä¸»æœºç³»ç»Ÿä¸Šå®‰è£…CUDAå·¥å…·åŒ…ï¼Œä½†éœ€è¦å®‰è£… `NVIDIA Driver` ä»¥åŠ `NVIDIA Container Toolkit`ï¼Œè¯·å‚è€ƒ[å®‰è£…æŒ‡å—](https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html)
- é¦–æ¬¡æ‹‰å–å’Œå¯åŠ¨å‡éœ€è¦ä¸€å®šæ—¶é—´ï¼Œé¦–æ¬¡å¯åŠ¨æ—¶è¯·å‚ç…§ä¸‹å›¾ä½¿ç”¨ `docker logs -f <container id>` æŸ¥çœ‹æ—¥å¿—
- å¦‚é‡åˆ°å¯åŠ¨è¿‡ç¨‹å¡åœ¨ `Waiting..` æ­¥éª¤ï¼Œå»ºè®®ä½¿ç”¨`docker exec -it <container id> bash` è¿›å…¥ `/logs/` ç›®å½•æŸ¥çœ‹å¯¹åº”é˜¶æ®µæ—¥å¿—

### é…ç½®æµç¨‹

æœ¬é¡¹ç›®å·²åœ¨ Python 3.8.1 - 3.10ï¼ŒCUDA 11.7 ç¯å¢ƒä¸‹å®Œæˆæµ‹è¯•ã€‚å·²åœ¨ Windowsã€ARM æ¶æ„çš„ macOSã€Linux ç³»ç»Ÿä¸­å®Œæˆæµ‹è¯•ã€‚

### 1. å¼€å‘ç¯å¢ƒå‡†å¤‡

å‚è§ [å¼€å‘ç¯å¢ƒå‡†å¤‡](docs/INSTALL.md)ã€‚

**è¯·æ³¨æ„ï¼š** `0.2.0`åŠæ›´æ–°ç‰ˆæœ¬çš„ä¾èµ–åŒ…ä¸`0.1.x`ç‰ˆæœ¬ä¾èµ–åŒ…å¯èƒ½å‘ç”Ÿå†²çªï¼Œå¼ºçƒˆå»ºè®®æ–°å»ºç¯å¢ƒåé‡æ–°å®‰è£…ä¾èµ–åŒ…ã€‚


### 2. ä¸‹è½½æ¨¡å‹è‡³æœ¬åœ°

å¦‚éœ€åœ¨æœ¬åœ°æˆ–ç¦»çº¿ç¯å¢ƒä¸‹è¿è¡Œæœ¬é¡¹ç›®ï¼Œéœ€è¦é¦–å…ˆå°†é¡¹ç›®æ‰€éœ€çš„æ¨¡å‹ä¸‹è½½è‡³æœ¬åœ°ï¼Œé€šå¸¸å¼€æº LLM ä¸ Embedding æ¨¡å‹å¯ä»¥ä» [HuggingFace](https://huggingface.co/models) ä¸‹è½½ã€‚

ä»¥æœ¬é¡¹ç›®ä¸­é»˜è®¤ä½¿ç”¨çš„ LLM æ¨¡å‹ [THUDM/chatglm2-6b](https://huggingface.co/THUDM/chatglm2-6b) ä¸ Embedding æ¨¡å‹ [moka-ai/m3e-base](https://huggingface.co/moka-ai/m3e-base) ä¸ºä¾‹ï¼š

ä¸‹è½½æ¨¡å‹éœ€è¦å…ˆ[å®‰è£…Git LFS](https://docs.github.com/zh/repositories/working-with-files/managing-large-files/installing-git-large-file-storage)ï¼Œç„¶åè¿è¡Œ

```Shell
$ git clone https://huggingface.co/THUDM/chatglm2-6b

$ git clone https://huggingface.co/moka-ai/m3e-base
```

### 3. è®¾ç½®é…ç½®é¡¹

å¤åˆ¶æ–‡ä»¶ [configs/model_config.py.example](configs/model_config.py.example) å­˜å‚¨è‡³é¡¹ç›®è·¯å¾„ä¸‹ `./configs` è·¯å¾„ä¸‹ï¼Œå¹¶é‡å‘½åä¸º `model_config.py`ã€‚

åœ¨å¼€å§‹æ‰§è¡Œ Web UI æˆ–å‘½ä»¤è¡Œäº¤äº’å‰ï¼Œè¯·å…ˆæ£€æŸ¥ `configs/model_config.py` ä¸­çš„å„é¡¹æ¨¡å‹å‚æ•°è®¾è®¡æ˜¯å¦ç¬¦åˆéœ€æ±‚ï¼š

- è¯·ç¡®è®¤å·²ä¸‹è½½è‡³æœ¬åœ°çš„ LLM æ¨¡å‹æœ¬åœ°å­˜å‚¨è·¯å¾„å†™åœ¨ `llm_model_dict` å¯¹åº”æ¨¡å‹çš„ `local_model_path` å±æ€§ä¸­ï¼Œå¦‚:

```python
llm_model_dict={
                "chatglm2-6b": {
                        "local_model_path": "/Users/xxx/Downloads/chatglm2-6b",
                        "api_base_url": "http://localhost:8888/v1",  # "name"ä¿®æ”¹ä¸ºfastchatæœåŠ¡ä¸­çš„"api_base_url"
                        "api_key": "EMPTY"
                    },
                }
```

- è¯·ç¡®è®¤å·²ä¸‹è½½è‡³æœ¬åœ°çš„ Embedding æ¨¡å‹æœ¬åœ°å­˜å‚¨è·¯å¾„å†™åœ¨ `embedding_model_dict` å¯¹åº”æ¨¡å‹ä½ç½®ï¼Œå¦‚ï¼š

```python
embedding_model_dict = {
                        "m3e-base": "/Users/xxx/Downloads/m3e-base",
                       }
```

### 4. çŸ¥è¯†åº“åˆå§‹åŒ–ä¸è¿ç§»

å½“å‰é¡¹ç›®çš„çŸ¥è¯†åº“ä¿¡æ¯å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œåœ¨æ­£å¼è¿è¡Œé¡¹ç›®ä¹‹å‰è¯·å…ˆåˆå§‹åŒ–æ•°æ®åº“ï¼ˆæˆ‘ä»¬å¼ºçƒˆå»ºè®®æ‚¨åœ¨æ‰§è¡Œæ“ä½œå‰å¤‡ä»½æ‚¨çš„çŸ¥è¯†æ–‡ä»¶ï¼‰ã€‚

- å¦‚æœæ‚¨æ˜¯ä» `0.1.x` ç‰ˆæœ¬å‡çº§è¿‡æ¥çš„ç”¨æˆ·ï¼Œé’ˆå¯¹å·²å»ºç«‹çš„çŸ¥è¯†åº“ï¼Œè¯·ç¡®è®¤çŸ¥è¯†åº“çš„å‘é‡åº“ç±»å‹ã€Embedding æ¨¡å‹ `configs/model_config.py` ä¸­é»˜è®¤è®¾ç½®ä¸€è‡´ï¼Œå¦‚æ— å˜åŒ–åªéœ€ä»¥ä¸‹å‘½ä»¤å°†ç°æœ‰çŸ¥è¯†åº“ä¿¡æ¯æ·»åŠ åˆ°æ•°æ®åº“å³å¯ï¼š
    ```shell
    $ python init_database.py
    ``` 
  
- å¦‚æœæ‚¨æ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œæœ¬é¡¹ç›®ï¼ŒçŸ¥è¯†åº“å°šæœªå»ºç«‹ï¼Œæˆ–è€…é…ç½®æ–‡ä»¶ä¸­çš„çŸ¥è¯†åº“ç±»å‹ã€åµŒå…¥æ¨¡å‹å‘ç”Ÿå˜åŒ–ï¼Œéœ€è¦ä»¥ä¸‹å‘½ä»¤åˆå§‹åŒ–æˆ–é‡å»ºçŸ¥è¯†åº“ï¼š
    ```shell
    $ python init_database.py --recreate-vs
    ```

### 5. å¯åŠ¨ API æœåŠ¡æˆ– Web UI

#### 5.1 å¯åŠ¨ LLM æœåŠ¡

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹ï¼Œæ‰§è¡Œ [server/llm_api.py](server/llm_api.py) è„šæœ¬å¯åŠ¨ **LLM æ¨¡å‹**æœåŠ¡ï¼š

```shell
$ python server/llm_api.py
```

ä»¥å¦‚ä¸Šæ–¹å¼å¯åŠ¨LLMæœåŠ¡ä¼šä»¥nohupå‘½ä»¤åœ¨åå°è¿è¡Œ fastchat æœåŠ¡ï¼Œå¦‚éœ€åœæ­¢æœåŠ¡ï¼Œå¯ä»¥è¿è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š

```shell
$ python server/llm_api_shutdown.py --serve all 
```

äº¦å¯å•ç‹¬åœæ­¢ä¸€ä¸ª fastchat æœåŠ¡æ¨¡å—ï¼Œå¯é€‰ [`all`, `controller`, `model_worker`, `openai_api_server`]

#### 5.2 å¯åŠ¨ API æœåŠ¡

å¯åŠ¨ **LLM æœåŠ¡**åï¼Œæ‰§è¡Œ [server/api.py](server/api.py) è„šæœ¬å¯åŠ¨ **API** æœåŠ¡

```shell
$ python server/api.py
```

å¯åŠ¨ API æœåŠ¡åï¼Œå¯è®¿é—® `localhost:7861` æˆ– `{API æ‰€åœ¨æœåŠ¡å™¨ IP}:7861` FastAPI è‡ªåŠ¨ç”Ÿæˆçš„ docs è¿›è¡Œæ¥å£æŸ¥çœ‹ä¸æµ‹è¯•ã€‚

- FastAPI docs ç•Œé¢

  ![](img/fastapi_docs_020_0.png)

#### 5.3 å¯åŠ¨ Web UI æœåŠ¡

æ‰§è¡Œ [webui.py](webui.py) å¯åŠ¨ **Web UI** æœåŠ¡ï¼ˆé»˜è®¤ä½¿ç”¨ç«¯å£`8501`ï¼‰

```shell
$ streamlit run webui.py
```

ä½¿ç”¨ Langchain-Chatchat ä¸»é¢˜è‰²å¯åŠ¨ **Web UI** æœåŠ¡ï¼ˆé»˜è®¤ä½¿ç”¨ç«¯å£`8501`ï¼‰

```shell
$ streamlit run webui.py --theme.base "light" --theme.primaryColor "#165dff" --theme.secondaryBackgroundColor "#f5f5f5" --theme.textColor "#000000"
```

æˆ–ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŒ‡å®šå¯åŠ¨ **Web UI** æœåŠ¡å¹¶æŒ‡å®šç«¯å£å·

```shell
$ streamlit run webui.py --server.port 666
```

- Web UI å¯¹è¯ç•Œé¢ï¼š

  ![](img/webui_0813_0.png)

- Web UI çŸ¥è¯†åº“ç®¡ç†é¡µé¢ï¼š

  ![](img/webui_0813_1.png)

---
